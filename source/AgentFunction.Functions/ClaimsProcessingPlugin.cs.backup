using System.ComponentModel;
using System.Text.Json;
using AgentFunction.Models;
using Microsoft.SemanticKernel;

namespace AgentFunction.Functions;

public class ClaimsProcessingPlugin
{
    [KernelFunction("is_claim_complete")]
    [Description("Validates if the claim is complete based on the provided claim data.")]
    public bool IsClaimComplete(string claim)
    {
        // Assume claim is a JSON string; check for required fields
        if (claim is null)
        {
            return false;
        }

        try
        {
            var claimData = JsonSerializer.Deserialize<Claim>(claim);

            bool isComplete = claimData is not null &&
                              !string.IsNullOrWhiteSpace(claimData.ClaimId) &&
                              !string.IsNullOrWhiteSpace(claimData.ClaimantName) &&
                              !string.IsNullOrWhiteSpace(claimData.PolicyNumber) &&
                              claimData.AmountClaimed > 0 &&
                              claimData.DateOfAccident != default;

            return isComplete;
        }
        catch (JsonException)
        {
            // Invalid JSON
            return false;
        }
    }

    [KernelFunction("is_claim_fraudulent")]
    [Description("Detects if the claim is potentially fraudulent based on claim details and history.")]
    public bool IsClaimFraudulent(string claim, string claimHistory)
    {
        Console.WriteLine($"IsClaimFraudulent called with claim: {claim}");
        Console.WriteLine($"IsClaimFraudulent called with claimHistory: {claimHistory}");

        try
        {
            var claimHistoryItem = JsonSerializer.Deserialize<ClaimHistoryResult>(claimHistory);
            var claimItem = JsonSerializer.Deserialize<Claim>(claim);

            if (claimItem is null || claimHistoryItem is null)
            {
                return false;
            }

            // Simple fraud detection logic
            if (claimItem.AmountClaimed > 10000 && claimHistoryItem.TotalClaims > 5)
            {
                // Example rule: High claim amount with many previous claims
                return true;
            }

            if (claimItem.DateOfAccident < claimHistoryItem.MostRecentClaimDate.AddDays(-30))
            {
                // Example rule: Accident date is before the most recent claim date
                return true;
            }

            return false;
        }
        catch (JsonException ex)
        {
            Console.WriteLine($"JSON deserialization error: {ex.Message}");
            return false;
        }
    }
}